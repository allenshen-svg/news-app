<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<title>ğŸŒ å…¨çƒçƒ­ç‚¹ - æ—¶äº‹æ”¿ç»èšåˆ</title>
<style>
/* ==================== DESIGN TOKENS ==================== */
:root {
  --bg: #0a0a10;
  --bg-secondary: #0f0f18;
  --sidebar-bg: #0d0d15;
  --card: #16162a;
  --card-hover: #1e1e38;
  --border: #1e1e36;
  --border-light: #2a2a48;
  --text: #e8e8f4;
  --text-secondary: #9898b8;
  --text-muted: #686888;
  --accent: #6c5ce7;
  --accent-light: #a29bfe;
  --accent-bg: rgba(108,92,231,0.1);
  --red: #ff6b6b;
  --orange: #ffa502;
  --green: #2ed573;
  --blue: #1e90ff;
  --yellow: #ffd93d;
  --pink: #f368e0;
  --gradient-accent: linear-gradient(135deg, #6c5ce7, #a29bfe);
  --gradient-hot: linear-gradient(135deg, #ff6b6b, #ffa502);
  --gradient-cool: linear-gradient(135deg, #2ed573, #1e90ff);
  --radius: 12px;
  --radius-lg: 16px;
  --radius-sm: 8px;
  --shadow: 0 4px 24px rgba(0,0,0,0.35);
  --shadow-lg: 0 8px 40px rgba(0,0,0,0.5);
  --sidebar-w: 240px;
  --header-h: 56px;
  --transition: 0.2s ease;
}

/* ==================== RESET ==================== */
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html { scroll-behavior:smooth; }
body {
  font-family: -apple-system, 'SF Pro Display', 'PingFang SC', 'Helvetica Neue', sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  min-height: 100vh;
  overflow-x: hidden;
}

/* ==================== TYPOGRAPHY ==================== */
.text-xs { font-size: 11px; }
.text-sm { font-size: 12px; }
.text-base { font-size: 14px; }
.text-lg { font-size: 16px; }
.text-xl { font-size: 20px; }
.text-2xl { font-size: 24px; }
.text-muted { color: var(--text-secondary); }
.text-accent { color: var(--accent-light); }
.font-bold { font-weight: 700; }
.font-black { font-weight: 900; }

/* ==================== APP LAYOUT ==================== */
.app {
  display: flex;
  min-height: 100vh;
}

/* ==================== SIDEBAR ==================== */
.sidebar {
  position: fixed;
  top: 0;
  left: 0;
  bottom: 0;
  width: var(--sidebar-w);
  background: var(--sidebar-bg);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  z-index: 200;
  overflow-y: auto;
  overflow-x: hidden;
  scrollbar-width: thin;
  scrollbar-color: var(--border) transparent;
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.sidebar::-webkit-scrollbar { width: 3px; }
.sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.sidebar-brand {
  padding: 20px 18px 16px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.sidebar-logo {
  font-size: 18px;
  font-weight: 900;
  background: var(--gradient-accent);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  letter-spacing: -0.3px;
}
.sidebar-tagline {
  font-size: 10px;
  color: var(--text-secondary);
  margin-top: 2px;
}

/* Sidebar Navigation */
.sidebar-nav {
  flex: 1;
  padding: 8px 0;
  overflow-y: auto;
}

.nav-group {
  padding: 4px 10px;
}
.nav-group-label {
  font-size: 10px;
  font-weight: 700;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 1.2px;
  padding: 12px 10px 6px;
  user-select: none;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 9px 12px;
  margin: 1px 0;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all var(--transition);
  user-select: none;
  position: relative;
}
.nav-item:hover {
  background: rgba(108,92,231,0.08);
  color: var(--text);
}
.nav-item.active {
  background: var(--accent-bg);
  color: var(--accent-light);
  font-weight: 700;
}
.nav-item.active::before {
  content: '';
  position: absolute;
  left: 0;
  top: 6px;
  bottom: 6px;
  width: 3px;
  border-radius: 0 3px 3px 0;
  background: var(--accent);
}
.nav-item .nav-icon {
  font-size: 15px;
  width: 20px;
  text-align: center;
  flex-shrink: 0;
}
.nav-item .nav-count {
  margin-left: auto;
  font-size: 10px;
  font-weight: 700;
  color: var(--text-secondary);
  background: rgba(255,255,255,0.06);
  padding: 2px 7px;
  border-radius: 10px;
  min-width: 24px;
  text-align: center;
}
.nav-item.active .nav-count {
  background: rgba(108,92,231,0.2);
  color: var(--accent-light);
}

/* Collapsible section */
.nav-collapsible-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 9px 12px;
  margin: 1px 0;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 700;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all var(--transition);
  user-select: none;
}
.nav-collapsible-header:hover {
  background: rgba(255,255,255,0.03);
  color: var(--text);
}
.nav-collapsible-header .collapse-arrow {
  font-size: 10px;
  transition: transform 0.3s;
  opacity: 0.5;
}
.nav-collapsible-header.collapsed .collapse-arrow {
  transform: rotate(-90deg);
}
.nav-collapsible-body {
  overflow: hidden;
  max-height: 300px;
  transition: max-height 0.3s ease, opacity 0.3s ease;
  opacity: 1;
}
.nav-collapsible-body.collapsed {
  max-height: 0;
  opacity: 0;
}
.nav-collapsible-body .nav-item {
  padding-left: 22px;
  font-size: 12px;
}

/* Hot rank mini in sidebar */
.nav-hot-badge {
  font-size: 9px;
  font-weight: 700;
  padding: 1px 6px;
  border-radius: 6px;
  color: white;
  margin-left: auto;
}
.nav-hot-badge.douyin { background: linear-gradient(135deg,#fe2c55,#25f4ee); }
.nav-hot-badge.xiaohongshu { background: linear-gradient(135deg,#fe2442,#ff6d6d); }
.nav-hot-badge.toutiao { background: linear-gradient(135deg,#f85959,#ff3b30); }
.nav-hot-badge.kr36 { background: linear-gradient(135deg,#1a73e8,#4fc3f7); }

/* Sidebar divider */
.sidebar-divider {
  height: 1px;
  background: var(--border);
  margin: 6px 16px;
}

/* Sidebar bottom */
.sidebar-bottom {
  padding: 8px 10px 16px;
  border-top: 1px solid var(--border);
  flex-shrink: 0;
}
.sidebar-bottom .nav-item {
  font-size: 12px;
}

/* Sidebar update info */
.sidebar-update {
  padding: 10px 14px;
  font-size: 10px;
  color: var(--text-muted);
  line-height: 1.5;
  border-top: 1px solid var(--border);
  flex-shrink: 0;
}
.sidebar-update .update-dot {
  display: inline-block;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--green);
  margin-right: 4px;
  animation: pulse-dot 2s infinite;
}
@keyframes pulse-dot {
  0%,100% { opacity:1; transform:scale(1); }
  50% { opacity:0.4; transform:scale(0.8); }
}

/* ==================== SIDEBAR OVERLAY (mobile) ==================== */
.sidebar-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  backdrop-filter: blur(4px);
  z-index: 190;
  opacity: 0;
  transition: opacity 0.3s;
}
.sidebar-overlay.show {
  display: block;
  opacity: 1;
}

/* ==================== MAIN CONTENT ==================== */
.main-content {
  flex: 1;
  margin-left: var(--sidebar-w);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* ==================== CONTENT HEADER ==================== */
.content-header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: rgba(10,10,16,0.88);
  backdrop-filter: blur(24px);
  -webkit-backdrop-filter: blur(24px);
  padding: 12px 24px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  min-height: var(--header-h);
}

.hamburger-btn {
  display: none;
  background: none;
  border: none;
  font-size: 22px;
  color: var(--text);
  cursor: pointer;
  padding: 6px;
  border-radius: var(--radius-sm);
  transition: background var(--transition);
  flex-shrink: 0;
}
.hamburger-btn:hover { background: rgba(255,255,255,0.06); }

.content-header-left {
  display: flex;
  align-items: baseline;
  gap: 12px;
  flex-shrink: 0;
}
.page-title {
  font-size: 18px;
  font-weight: 800;
  white-space: nowrap;
}
.page-subtitle {
  font-size: 11px;
  color: var(--text-secondary);
  white-space: nowrap;
}

.content-header-right {
  display: flex;
  align-items: center;
  gap: 8px;
  flex: 1;
  justify-content: flex-end;
  max-width: 500px;
}

/* Search in header */
.search-wrap {
  position: relative;
  flex: 1;
  max-width: 280px;
}
.search-icon {
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 13px;
  color: var(--text-secondary);
  pointer-events: none;
}
.search-input {
  width: 100%;
  padding: 8px 12px 8px 32px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 20px;
  color: var(--text);
  font-size: 12px;
  outline: none;
  transition: all var(--transition);
}
.search-input:focus {
  border-color: var(--accent);
  background: var(--card-hover);
  box-shadow: 0 0 0 3px rgba(108,92,231,0.12);
}
.search-input::placeholder { color: var(--text-secondary); }

.header-action {
  display: flex;
  align-items: center;
  gap: 4px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 6px 12px;
  color: var(--text-secondary);
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition);
  white-space: nowrap;
  flex-shrink: 0;
}
.header-action:hover {
  background: var(--accent);
  color: white;
  border-color: var(--accent);
}
.header-action .live-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--green);
  animation: pulse-dot 2s infinite;
}

/* ==================== CONTENT BODY ==================== */
.content-body {
  flex: 1;
  padding: 20px 24px 40px;
  max-width: 1100px;
  width: 100%;
  margin: 0 auto;
}

/* ==================== BREAKING BANNER ==================== */
.breaking {
  margin-bottom: 20px;
  padding: 12px 16px;
  background: linear-gradient(135deg, rgba(255,107,107,0.1), rgba(255,165,2,0.08));
  border: 1px solid rgba(255,107,107,0.25);
  border-radius: var(--radius);
  display: none;
  cursor: pointer;
  transition: all var(--transition);
}
.breaking:hover {
  background: linear-gradient(135deg, rgba(255,107,107,0.15), rgba(255,165,2,0.12));
  border-color: rgba(255,107,107,0.4);
}
.breaking-label {
  font-size: 10px;
  font-weight: 800;
  color: var(--red);
  text-transform: uppercase;
  letter-spacing: 1.2px;
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.breaking-label::before {
  content: '';
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: var(--red);
  animation: pulse-dot 1s infinite;
}
.breaking-title {
  font-size: 14px;
  font-weight: 700;
  line-height: 1.5;
}

/* ==================== HOT TRENDING SECTION ==================== */
.hot-section {
  margin-bottom: 24px;
}
.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}
.section-title {
  font-size: 15px;
  font-weight: 800;
  display: flex;
  align-items: center;
  gap: 8px;
}
.section-title .fire { animation: fireAnim 0.6s ease-in-out infinite alternate; }
@keyframes fireAnim { from{transform:scale(1)} to{transform:scale(1.15) rotate(-5deg)} }

.section-action {
  font-size: 11px;
  color: var(--accent-light);
  cursor: pointer;
  padding: 4px 12px;
  border-radius: 14px;
  background: var(--accent-bg);
  border: none;
  font-weight: 600;
  transition: all var(--transition);
}
.section-action:hover {
  background: rgba(108,92,231,0.2);
}

.hot-platform-tabs {
  display: flex;
  gap: 6px;
  margin-bottom: 12px;
  overflow-x: auto;
  scrollbar-width: none;
}
.hot-platform-tabs::-webkit-scrollbar { display: none; }

.hot-tab {
  padding: 5px 14px;
  border-radius: 16px;
  font-size: 11px;
  font-weight: 700;
  cursor: pointer;
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--text-secondary);
  transition: all var(--transition);
  white-space: nowrap;
  flex-shrink: 0;
}
.hot-tab:hover { background: var(--card-hover); color: var(--text); }
.hot-tab.active { color: white; border-color: transparent; }
.hot-tab[data-platform='all'].active { background: var(--gradient-accent); }
.hot-tab[data-platform='æŠ–éŸ³çƒ­æœ'].active { background: linear-gradient(135deg,#fe2c55,#25f4ee); }
.hot-tab[data-platform='å°çº¢ä¹¦çƒ­é—¨'].active { background: linear-gradient(135deg,#fe2442,#ff6d6d); }
.hot-tab[data-platform='ä»Šæ—¥å¤´æ¡'].active { background: linear-gradient(135deg,#f85959,#ff3b30); }
.hot-tab[data-platform='36æ°ªå¿«è®¯'].active { background: linear-gradient(135deg,#1a73e8,#4fc3f7); }

.hot-list {
  display: grid;
  grid-template-columns: 1fr;
  background: var(--card);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  overflow: hidden;
  max-height: 480px;
  overflow-y: auto;
  scrollbar-width: thin;
}
@media(min-width:700px) { .hot-list { grid-template-columns: 1fr 1fr; } }

.hot-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 14px;
  cursor: pointer;
  transition: background var(--transition);
  border-bottom: 1px solid rgba(30,30,54,0.6);
}
.hot-item:hover { background: var(--card-hover); }
.hot-rank {
  width: 22px;
  height: 22px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: 800;
  flex-shrink: 0;
  color: white;
}
.hot-rank.top1 { background: linear-gradient(135deg,#ff6b6b,#ee5a24); }
.hot-rank.top2 { background: linear-gradient(135deg,#ffa502,#ff7f50); }
.hot-rank.top3 { background: linear-gradient(135deg,#ffd93d,#f39c12); }
.hot-rank.normal { background: var(--border); color: var(--text-secondary); }
.hot-info { flex: 1; min-width: 0; }
.hot-title-text {
  font-size: 13px;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.hot-meta {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-top: 2px;
}
.hot-heat { font-size: 10px; color: var(--red); font-weight: 600; }
.hot-platform-badge {
  font-size: 9px;
  padding: 1px 6px;
  border-radius: 6px;
  font-weight: 600;
  color: white;
}
.hot-platform-badge.æŠ–éŸ³çƒ­æœ { background:linear-gradient(135deg,#fe2c55,#25f4ee); }
.hot-platform-badge.å°çº¢ä¹¦çƒ­é—¨ { background:linear-gradient(135deg,#fe2442,#ff6d6d); }
.hot-platform-badge.ä»Šæ—¥å¤´æ¡ { background:linear-gradient(135deg,#f85959,#ff3b30); }
.hot-platform-badge.x36æ°ªå¿«è®¯, .hot-platform-badge.kr36 { background:linear-gradient(135deg,#1a73e8,#4fc3f7); }
.hot-cat-tag { font-size: 9px; padding: 1px 6px; border-radius: 6px; font-weight: 600; }

/* ==================== TREND DISCOVERY ==================== */
.trend-section {
  margin-bottom: 24px;
}
.trend-summary-strip {
  display: flex;
  gap: 8px;
  overflow-x: auto;
  scrollbar-width: none;
  margin-bottom: 12px;
}
.trend-summary-strip::-webkit-scrollbar { display: none; }
.trend-summary-chip {
  white-space: nowrap;
  padding: 4px 12px;
  border-radius: 14px;
  font-size: 11px;
  font-weight: 600;
  flex-shrink: 0;
}
.trend-summary-chip.burst-count { background:rgba(255,107,107,0.12); color:var(--red); }
.trend-summary-chip.rising-count { background:rgba(46,213,115,0.12); color:var(--green); }
.trend-summary-chip.total-count { background:rgba(108,92,231,0.12); color:var(--accent-light); }
.trend-summary-chip.algo-info { background:rgba(255,165,2,0.12); color:var(--orange); }

.trend-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 10px;
}
@media(min-width:640px) { .trend-grid { grid-template-columns: 1fr 1fr; } }
@media(min-width:960px) { .trend-grid { grid-template-columns: 1fr 1fr 1fr; } }

.trend-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px;
  cursor: pointer;
  transition: all var(--transition);
  position: relative;
  overflow: hidden;
}
.trend-card:hover { background:var(--card-hover); transform:translateY(-2px); box-shadow:var(--shadow); }
.trend-card.burst { border-color:rgba(255,107,107,0.4); background:linear-gradient(135deg,rgba(255,107,107,0.05),rgba(255,165,2,0.04)); }
.trend-card.burst::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; background:var(--gradient-hot); }
.trend-card.bullish { border-color:rgba(46,213,115,0.3); }
.trend-card-top { display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; }
.trend-rank-num { font-size:14px; font-weight:800; color:var(--accent-light); }
.trend-direction { font-size:16px; }
.trend-heat-bar { height:3px; border-radius:2px; background:var(--border); overflow:hidden; margin-bottom:8px; }
.trend-heat-fill { height:100%; border-radius:2px; transition:width 0.6s ease-out; }
.trend-heat-fill.high { background:var(--gradient-hot); }
.trend-heat-fill.medium { background:linear-gradient(90deg,var(--orange),var(--yellow)); }
.trend-heat-fill.low { background:linear-gradient(90deg,var(--blue),var(--accent)); }
.trend-keyword { font-size:14px; font-weight:700; margin-bottom:4px; display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
.trend-keyword .burst-badge { font-size:9px; padding:1px 6px; border-radius:6px; background:var(--gradient-hot); color:white; font-weight:700; animation:pulse-dot 1s infinite; }
.trend-keyword .macd-badge { font-size:9px; padding:1px 6px; border-radius:6px; font-weight:700; }
.trend-keyword .macd-badge.bullish { background:rgba(46,213,115,0.15); color:var(--green); }
.trend-keyword .macd-badge.bearish { background:rgba(255,107,107,0.15); color:var(--red); }
.trend-meta { display:flex; align-items:center; gap:6px; flex-wrap:wrap; margin-bottom:6px; }
.trend-meta-item { font-size:10px; color:var(--text-secondary); }
.trend-meta-item.heat { color:var(--red); font-weight:600; }
.trend-platforms { display:flex; gap:3px; }
.trend-platform-dot { width:6px; height:6px; border-radius:50%; }
.trend-platform-dot.douyin { background:#fe2c55; }
.trend-platform-dot.xiaohongshu { background:#fe2442; }
.trend-platform-dot.weibo { background:#ff8200; }
.trend-platform-dot.bilibili { background:#00a1d6; }
.trend-platform-dot.zhihu { background:#0066ff; }
.trend-platform-dot.baidu { background:#2932e1; }
.trend-sparkline { margin-top:6px; }
.trend-sparkline svg { display:block; }
.trend-sparkline .spark-line { fill:none; stroke-width:1.5; stroke-linecap:round; stroke-linejoin:round; }
.trend-sparkline .spark-area { opacity:0.12; }
.trend-sparkline.burst .spark-line { stroke:var(--red); }
.trend-sparkline.burst .spark-area { fill:var(--red); }
.trend-sparkline.bullish .spark-line { stroke:var(--green); }
.trend-sparkline.bullish .spark-area { fill:var(--green); }
.trend-sparkline.neutral .spark-line { stroke:var(--accent-light); }
.trend-sparkline.neutral .spark-area { fill:var(--accent-light); }
.trend-related { font-size:10px; color:var(--text-secondary); line-height:1.5; margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

/* ==================== NEWS LIST ==================== */
.news-list {
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
}
@media (min-width:640px) { .news-list { grid-template-columns: repeat(2,1fr); } }
@media (min-width:960px) { .news-list { grid-template-columns: repeat(3,1fr); } }

.news-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  cursor: pointer;
  transition: all var(--transition);
  position: relative;
  overflow: hidden;
}
.news-card:hover {
  background: var(--card-hover);
  transform: translateY(-2px);
  box-shadow: var(--shadow);
  border-color: var(--border-light);
}
.news-card:active {
  transform: translateY(0);
}
.news-card.importance-5 { border-left: 3px solid var(--red); }
.news-card.importance-4 { border-left: 3px solid var(--orange); }
.news-card.importance-3 { border-left: 3px solid var(--blue); }

.news-top {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 8px;
  flex-wrap: wrap;
}
.news-source { font-size: 10px; color: var(--text-secondary); font-weight: 600; }
.news-time { font-size: 10px; color: var(--text-secondary); opacity: 0.7; }
.news-cat {
  font-size: 9px;
  padding: 2px 8px;
  border-radius: 10px;
  font-weight: 600;
  color: white;
}
.cat-å›½é™… { background:linear-gradient(135deg,#6c5ce7,#a29bfe); }
.cat-è´¢ç» { background:linear-gradient(135deg,#ffa502,#ff6b6b); }
.cat-æ”¿æ²» { background:linear-gradient(135deg,#1e90ff,#2ed573); }
.cat-ç§‘æŠ€ { background:linear-gradient(135deg,#f368e0,#a29bfe); }
.cat-æ—¶äº‹ { background:linear-gradient(135deg,#ff6b6b,#f368e0); }
.cat-ç¤¾ä¼š { background:linear-gradient(135deg,#2ed573,#ffd93d); }

.news-title {
  font-size: 14px;
  font-weight: 700;
  line-height: 1.55;
  margin-bottom: 6px;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.news-summary {
  font-size: 12px;
  color: var(--text-secondary);
  line-height: 1.65;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.news-bottom {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-top: 10px;
  flex-wrap: wrap;
}
.news-region {
  font-size: 9px;
  padding: 2px 7px;
  border-radius: 6px;
  background: rgba(108,92,231,0.1);
  color: var(--accent-light);
}
.news-lang {
  font-size: 9px;
  padding: 2px 7px;
  border-radius: 6px;
  background: rgba(136,136,170,0.1);
  color: var(--text-secondary);
}
.news-importance { font-size: 9px; }

/* Card with image */
.news-card.has-image .news-inner { display:grid; grid-template-columns:1fr 90px; gap:12px; }
.news-image { width:90px; height:70px; border-radius:var(--radius-sm); object-fit:cover; align-self:start; }

/* ==================== TIMELINE VIEW ==================== */
.timeline-view { display:none; max-width:800px; }
.timeline-date {
  font-size: 12px;
  font-weight: 700;
  color: var(--accent-light);
  padding: 14px 0 8px;
  position: sticky;
  top: var(--header-h);
  background: var(--bg);
  z-index: 10;
  border-bottom: 1px solid var(--border);
}
.timeline-item {
  display: flex;
  gap: 12px;
  padding: 12px 0;
  border-bottom: 1px solid rgba(30,30,54,0.4);
  cursor: pointer;
  transition: background var(--transition);
  border-radius: var(--radius-sm);
  padding-left: 4px;
  padding-right: 4px;
}
.timeline-item:hover { background: rgba(108,92,231,0.04); }
.timeline-dot { width:8px; height:8px; border-radius:50%; background:var(--accent); margin-top:6px; flex-shrink:0; }
.timeline-dot.high { background:var(--red); }
.timeline-dot.medium { background:var(--orange); }
.timeline-content { flex:1; min-width:0; }
.timeline-time { font-size:10px; color:var(--text-secondary); }
.timeline-title {
  font-size: 13px;
  font-weight: 600;
  margin: 2px 0;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.timeline-source { font-size:10px; color:var(--text-secondary); }

/* ==================== SETTINGS VIEW ==================== */
.settings-view { display:none; max-width:640px; }
.settings-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 16px;
}
.settings-title {
  font-size: 14px;
  font-weight: 800;
  margin-bottom: 14px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.settings-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 0;
  border-bottom: 1px solid var(--border);
}
.settings-row:last-child { border-bottom:none; }
.settings-label { font-size: 13px; font-weight: 500; }
.settings-desc { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
.settings-input {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 10px 14px;
  color: var(--text);
  font-size: 12px;
  width: 100%;
  margin-top: 8px;
  outline: none;
  transition: border var(--transition);
}
.settings-input:focus { border-color:var(--accent); box-shadow:0 0 0 3px rgba(108,92,231,0.1); }
.settings-btn {
  width: 100%;
  padding: 11px;
  background: var(--gradient-accent);
  color: white;
  border: none;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  margin-top: 12px;
  transition: opacity var(--transition);
}
.settings-btn:hover { opacity: 0.9; }
.settings-btn:active { opacity: 0.8; }

/* Toggle Switch */
.toggle {
  width: 42px;
  height: 24px;
  border-radius: 12px;
  background: #333;
  position: relative;
  cursor: pointer;
  transition: background 0.3s;
  flex-shrink: 0;
}
.toggle.on { background: var(--accent); }
.toggle::after {
  content: '';
  position: absolute;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: white;
  top: 2px;
  left: 2px;
  transition: transform 0.3s;
}
.toggle.on::after { transform:translateX(18px); }

/* ==================== DETAIL MODAL ==================== */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(8px);
  z-index: 300;
  display: none;
  align-items: flex-end;
  justify-content: center;
}
.modal-overlay.show { display: flex; }
.modal-content {
  background: var(--card);
  max-width: 700px;
  width: 100%;
  max-height: 85vh;
  border-radius: 20px 20px 0 0;
  overflow-y: auto;
  animation: slideUp 0.3s ease-out;
}
@keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
.modal-handle { width:36px; height:4px; background:#444; border-radius:2px; margin:12px auto; }
.modal-body { padding:0 24px 32px; }
.modal-cat { display:inline-block; font-size:10px; padding:3px 10px; border-radius:10px; font-weight:600; color:white; margin-bottom:10px; }
.modal-title { font-size:20px; font-weight:800; line-height:1.5; margin-bottom:10px; }
.modal-meta { display:flex; align-items:center; gap:10px; margin-bottom:16px; flex-wrap:wrap; }
.modal-meta-item { font-size:11px; color:var(--text-secondary); display:flex; align-items:center; gap:4px; }
.modal-summary {
  font-size: 14px;
  line-height: 1.8;
  color: var(--text);
  margin-bottom: 16px;
  padding: 16px;
  background: rgba(108,92,231,0.06);
  border-radius: var(--radius);
  border-left: 3px solid var(--accent);
}
.modal-regions { display:flex; gap:6px; flex-wrap:wrap; margin-bottom:16px; }
.modal-link {
  display: block;
  text-align: center;
  padding: 12px;
  background: var(--gradient-accent);
  color: white;
  border-radius: var(--radius);
  font-size: 13px;
  font-weight: 700;
  text-decoration: none;
  transition: opacity var(--transition);
}
.modal-link:hover { opacity:0.9; }

/* AI analysis section */
.ai-section {
  margin-bottom: 16px;
  padding: 16px;
  background: rgba(46,213,115,0.06);
  border-radius: var(--radius);
  border: 1px solid rgba(46,213,115,0.15);
}
.ai-section-title { font-size:12px; font-weight:700; color:var(--green); margin-bottom:8px; display:flex; align-items:center; gap:6px; }
.ai-section-text { font-size:13px; line-height:1.7; color:var(--text); }
.ai-loading { text-align:center; padding:20px; color:var(--text-secondary); font-size:12px; }

/* ==================== LOADING & EMPTY STATES ==================== */
.loading { text-align:center; padding:60px 20px; }
.spinner {
  width: 36px;
  height: 36px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin: 0 auto;
}
@keyframes spin { to { transform:rotate(360deg); } }
.loading-text { font-size:12px; color:var(--text-secondary); margin-top:14px; }

.empty {
  text-align: center;
  padding: 80px 24px;
  grid-column: 1 / -1;
}
.empty-icon {
  font-size: 56px;
  margin-bottom: 16px;
  opacity: 0.8;
}
.empty-title {
  font-size: 18px;
  font-weight: 800;
  margin-bottom: 8px;
}
.empty-desc {
  font-size: 13px;
  color: var(--text-secondary);
  line-height: 1.7;
  max-width: 360px;
  margin: 0 auto;
}
.empty-btn {
  display: inline-block;
  margin-top: 20px;
  padding: 10px 28px;
  background: var(--gradient-accent);
  color: white;
  border: none;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  transition: opacity var(--transition);
}
.empty-btn:hover { opacity:0.9; }

/* ==================== BACK TO TOP ==================== */
.back-to-top {
  position: fixed;
  bottom: 28px;
  right: 28px;
  width: 42px;
  height: 42px;
  border-radius: 50%;
  background: var(--accent);
  color: white;
  border: none;
  font-size: 16px;
  cursor: pointer;
  z-index: 150;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 16px rgba(108,92,231,0.4);
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.3s;
  pointer-events: none;
}
.back-to-top.show {
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
}
.back-to-top:hover {
  background: var(--accent-light);
  transform: translateY(-2px);
  box-shadow: 0 6px 24px rgba(108,92,231,0.5);
}

/* ==================== TOAST ==================== */
.toast {
  position: fixed;
  bottom: 36px;
  left: 50%;
  transform: translateX(-50%) translateY(60px);
  background: var(--card);
  color: var(--text);
  padding: 10px 24px;
  border-radius: 24px;
  font-size: 12px;
  font-weight: 600;
  box-shadow: var(--shadow-lg);
  z-index: 500;
  transition: transform 0.3s;
  border: 1px solid var(--border);
  white-space: nowrap;
  pointer-events: none;
}
.toast.show { transform: translateX(-50%) translateY(0); }

/* ==================== SCROLLBAR ==================== */
::-webkit-scrollbar { width:4px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }

/* ==================== RESPONSIVE ==================== */

/* Tablet: sidebar narrower */
@media (max-width: 1024px) {
  :root { --sidebar-w: 210px; }
  .content-body { padding: 16px 20px 40px; }
}

/* Mobile: sidebar becomes drawer */
@media (max-width: 768px) {
  .sidebar {
    transform: translateX(-100%);
    width: 280px;
    box-shadow: var(--shadow-lg);
  }
  .sidebar.open {
    transform: translateX(0);
  }
  .main-content {
    margin-left: 0;
  }
  .hamburger-btn {
    display: flex;
  }
  .content-header {
    padding: 10px 16px;
  }
  .content-header-left .page-title {
    font-size: 15px;
  }
  .content-header-left .page-subtitle {
    display: none;
  }
  .content-body {
    padding: 14px 14px 32px;
  }
  .search-wrap {
    max-width: 160px;
  }
  .header-action .action-text {
    display: none;
  }
  .back-to-top {
    bottom: 20px;
    right: 16px;
    width: 38px;
    height: 38px;
  }
  .news-list {
    gap: 10px;
  }
  .hot-list {
    grid-template-columns: 1fr;
  }
}

/* Very small screens */
@media (max-width: 480px) {
  .content-header-right {
    gap: 4px;
  }
  .search-wrap {
    max-width: 120px;
  }
  .header-action {
    padding: 6px 8px;
    font-size: 13px;
  }
}
</style>
</head>
<body>

<div class="app">

<!-- ==================== SIDEBAR ==================== -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-brand">
    <div class="sidebar-logo">ğŸŒ å…¨çƒçƒ­ç‚¹</div>
    <div class="sidebar-tagline">æ—¶äº‹æ”¿ç»æ–°é—»èšåˆ</div>
  </div>

  <nav class="sidebar-nav">
    <!-- Source Group Navigation -->
    <div class="nav-group">
      <div class="nav-group-label">åˆ†ç±»</div>
      <div class="nav-item active" data-cat="all" onclick="sidebarFilter('all')">
        <span class="nav-icon">ğŸ”¥</span> å…¨éƒ¨
        <span class="nav-count" id="count-all">-</span>
      </div>
      <div class="nav-item" data-cat="cn" onclick="sidebarFilter('cn')">
        <span class="nav-icon">ğŸ“±</span> å›½å†…çƒ­æœ
        <span class="nav-count" id="count-cn">-</span>
      </div>
      <div class="nav-item" data-cat="finance" onclick="sidebarFilter('finance')">
        <span class="nav-icon">ğŸ’¹</span> è´¢ç»
        <span class="nav-count" id="count-finance">-</span>
      </div>
      <div class="nav-item" data-cat="world" onclick="sidebarFilter('world')">
        <span class="nav-icon">ğŸŒ</span> å¤–åª’
        <span class="nav-count" id="count-world">-</span>
      </div>
      <div class="nav-item" data-cat="tech" onclick="sidebarFilter('tech')">
        <span class="nav-icon">ğŸš€</span> ç§‘æŠ€
        <span class="nav-count" id="count-tech">-</span>
      </div>
      <div class="nav-item" data-cat="discover" onclick="sidebarFilter('discover')">
        <span class="nav-icon">ğŸ”¬</span> å‘ç°
        <span class="nav-count" id="count-discover">-</span>
      </div>
    </div>

    <div class="sidebar-divider"></div>

    <!-- Language filters -->
    <div class="nav-group">
      <div class="nav-group-label">è¯­è¨€</div>
      <div class="nav-item" data-cat="zh" onclick="sidebarFilter('zh')">
        <span class="nav-icon">ğŸ‡¨ğŸ‡³</span> ä¸­æ–‡
        <span class="nav-count" id="count-zh">-</span>
      </div>
      <div class="nav-item" data-cat="en" onclick="sidebarFilter('en')">
        <span class="nav-icon">ğŸŒ</span> English
        <span class="nav-count" id="count-en">-</span>
      </div>
    </div>

    <div class="sidebar-divider"></div>

    <!-- Collapsible Hot Search -->
    <div class="nav-group">
      <div class="nav-collapsible-header" id="hot-nav-header" onclick="toggleHotNav()">
        <span>ğŸ”¥ å®æ—¶çƒ­æœæ¦œ</span>
        <span class="collapse-arrow">â–¼</span>
      </div>
      <div class="nav-collapsible-body" id="hot-nav-body">
        <div class="nav-item" data-platform="all" onclick="sidebarHotFilter('all')">
          <span class="nav-icon">â­</span> å…¨éƒ¨å¹³å°
        </div>
        <div class="nav-item" data-platform="æŠ–éŸ³çƒ­æœ" onclick="sidebarHotFilter('æŠ–éŸ³çƒ­æœ')">
          <span class="nav-icon">ğŸµ</span> æŠ–éŸ³
          <span class="nav-hot-badge douyin" id="hot-count-douyin"></span>
        </div>
        <div class="nav-item" data-platform="å°çº¢ä¹¦çƒ­é—¨" onclick="sidebarHotFilter('å°çº¢ä¹¦çƒ­é—¨')">
          <span class="nav-icon">ğŸ“•</span> å°çº¢ä¹¦
          <span class="nav-hot-badge xiaohongshu" id="hot-count-xhs"></span>
        </div>
        <div class="nav-item" data-platform="ä»Šæ—¥å¤´æ¡" onclick="sidebarHotFilter('ä»Šæ—¥å¤´æ¡')">
          <span class="nav-icon">ğŸ“±</span> å¤´æ¡
          <span class="nav-hot-badge toutiao" id="hot-count-tt"></span>
        </div>
        <div class="nav-item" data-platform="36æ°ªå¿«è®¯" onclick="sidebarHotFilter('36æ°ªå¿«è®¯')">
          <span class="nav-icon">ğŸ’¼</span> 36æ°ª
          <span class="nav-hot-badge kr36" id="hot-count-kr"></span>
        </div>
      </div>
    </div>
  </nav>

  <!-- Sidebar bottom: views -->
  <div class="sidebar-bottom">
    <div class="nav-item active" data-view="news" onclick="switchView('news')">
      <span class="nav-icon">ğŸ“°</span> æ–°é—»
    </div>
    <div class="nav-item" data-view="timeline" onclick="switchView('timeline')">
      <span class="nav-icon">â±ï¸</span> æ—¶é—´çº¿
    </div>
    <div class="nav-item" data-view="settings" onclick="switchView('settings')">
      <span class="nav-icon">âš™ï¸</span> è®¾ç½®
    </div>
  </div>

  <div class="sidebar-update" id="sidebar-update">
    <span class="update-dot"></span>åŠ è½½ä¸­...
  </div>
</aside>

<!-- Sidebar overlay for mobile -->
<div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

<!-- ==================== MAIN CONTENT ==================== -->
<main class="main-content">

  <!-- Content Header -->
  <div class="content-header">
    <button class="hamburger-btn" onclick="toggleSidebar()" aria-label="èœå•">â˜°</button>
    <div class="content-header-left">
      <h1 class="page-title" id="page-title">å…¨éƒ¨æ–°é—»</h1>
      <span class="page-subtitle" id="header-meta">åŠ è½½ä¸­...</span>
    </div>
    <div class="content-header-right">
      <div class="search-wrap">
        <span class="search-icon">ğŸ”</span>
        <input class="search-input" id="search-input" type="text" placeholder="æœç´¢æ–°é—»..." oninput="handleSearch(this.value)">
      </div>
      <button class="header-action" onclick="manualTranslate()">ğŸŒ <span class="action-text">ç¿»è¯‘</span></button>
      <button class="header-action" id="btn-refresh" onclick="refreshNews()">
        <span class="live-dot"></span> <span class="action-text">åˆ·æ–°</span>
      </button>
    </div>
  </div>

  <!-- Content Body -->
  <div class="content-body">

    <!-- Breaking Banner -->
    <div class="breaking" id="breaking-banner">
      <div class="breaking-label">ğŸ”´ BREAKING</div>
      <div class="breaking-title" id="breaking-title"></div>
    </div>

    <!-- Trend Discovery Section -->
    <div class="trend-section" id="trend-section" style="display:none">
      <div class="section-header">
        <div class="section-title">
          <span class="fire">ğŸ”¬</span> çƒ­ç‚¹å‘ç°
        </div>
        <button class="section-action" onclick="toggleTrendExpand()">å±•å¼€/æ”¶èµ·</button>
      </div>
      <div class="trend-summary-strip" id="trend-summary"></div>
      <div class="trend-grid" id="trend-grid"></div>
    </div>

    <!-- Hot Trending Section -->
    <div class="hot-section" id="hot-section">
      <div class="section-header">
        <div class="section-title"><span class="fire">ğŸ”¥</span> å®æ—¶çƒ­æœæ¦œ</div>
        <button class="section-action" id="hot-collapse-btn" onclick="toggleHotSection()">æ”¶èµ·</button>
      </div>
      <div class="hot-platform-tabs" id="hot-tabs">
        <div class="hot-tab active" data-platform="all" onclick="filterHotPlatform('all')">å…¨éƒ¨</div>
        <div class="hot-tab" data-platform="æŠ–éŸ³çƒ­æœ" onclick="filterHotPlatform('æŠ–éŸ³çƒ­æœ')">ğŸµ æŠ–éŸ³</div>
        <div class="hot-tab" data-platform="å°çº¢ä¹¦çƒ­é—¨" onclick="filterHotPlatform('å°çº¢ä¹¦çƒ­é—¨')">ğŸ“• å°çº¢ä¹¦</div>
        <div class="hot-tab" data-platform="ä»Šæ—¥å¤´æ¡" onclick="filterHotPlatform('ä»Šæ—¥å¤´æ¡')">ğŸ“± å¤´æ¡</div>
        <div class="hot-tab" data-platform="36æ°ªå¿«è®¯" onclick="filterHotPlatform('36æ°ªå¿«è®¯')">ğŸ’¼ 36æ°ª</div>
      </div>
      <div class="hot-list" id="hot-list"></div>
    </div>

    <!-- News View -->
    <div id="view-news">
      <div class="news-list" id="news-list"></div>
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">æ­£åœ¨åŠ è½½å…¨çƒæ–°é—»...</div>
      </div>
      <div class="empty" id="empty-state" style="display:none">
        <div class="empty-icon">ğŸ“¡</div>
        <div class="empty-title">æš‚æ— æ–°é—»æ•°æ®</div>
        <div class="empty-desc">è¯·å…ˆè¿è¡ŒæŠ“å–è„šæœ¬è·å–æ–°é—»<br><code style="background:var(--bg);padding:4px 10px;border-radius:6px;font-size:11px;margin-top:6px;display:inline-block">python3 scripts/fetch_news.py</code></div>
        <button class="empty-btn" onclick="refreshNews()">ğŸ”„ é‡æ–°åŠ è½½</button>
      </div>
    </div>

    <!-- Timeline View -->
    <div class="timeline-view" id="view-timeline"></div>

    <!-- Settings View -->
    <div class="settings-view" id="view-settings">
      <div class="settings-card">
        <div class="settings-title">âš™ï¸ åŸºæœ¬è®¾ç½®</div>
        <div class="settings-row">
          <div>
            <div class="settings-label">è‡ªåŠ¨åˆ·æ–°</div>
            <div class="settings-desc">æ¯5åˆ†é’Ÿè‡ªåŠ¨æ£€æŸ¥æ–°é—»æ›´æ–°</div>
          </div>
          <div class="toggle on" id="toggle-refresh" onclick="toggleSetting('refresh')"></div>
        </div>
        <div class="settings-row">
          <div>
            <div class="settings-label">æµè§ˆå™¨é€šçŸ¥</div>
            <div class="settings-desc">çªå‘æ–°é—»æ—¶æ¨é€æ¡Œé¢é€šçŸ¥</div>
          </div>
          <div class="toggle" id="toggle-notify" onclick="toggleSetting('notify')"></div>
        </div>
        <div class="settings-row">
          <div>
            <div class="settings-label">ä»…æ˜¾ç¤ºä¸­æ–‡</div>
            <div class="settings-desc">è¿‡æ»¤æ‰è‹±æ–‡æ–°é—»</div>
          </div>
          <div class="toggle" id="toggle-zhonly" onclick="toggleSetting('zhonly')"></div>
        </div>
      </div>

      <div class="settings-card">
        <div class="settings-title">ğŸ¤– AI åˆ†æ <span style="font-size:10px;color:var(--text-secondary);font-weight:400">(å¯é€‰)</span></div>
        <div class="settings-desc" style="margin-bottom:10px">é…ç½®AIåå¯å¯¹æ–°é—»è¿›è¡Œæ·±åº¦åˆ†æå’Œå½±å“è¯„ä¼°</div>
        <input class="settings-input" id="ai-api-url" placeholder="API Base URL (ä¾‹å¦‚: https://api.siliconflow.cn/v1)">
        <input class="settings-input" id="ai-api-key" type="password" placeholder="API Key (sk-...)" style="margin-top:6px">
        <input class="settings-input" id="ai-api-model" placeholder="æ¨¡å‹ (ä¾‹å¦‚: deepseek-ai/DeepSeek-V3)" style="margin-top:6px">
        <button class="settings-btn" onclick="saveAIConfig()">ğŸ’¾ ä¿å­˜AIé…ç½®</button>
      </div>

      <div class="settings-card">
        <div class="settings-title">ğŸ“Š æ•°æ®ä¿¡æ¯</div>
        <div class="settings-desc" id="data-info" style="line-height:1.8">åŠ è½½ä¸­...</div>
      </div>

      <div class="settings-card">
        <div class="settings-title">ğŸ“‹ æ•°æ®æºåˆ—è¡¨</div>
        <div id="source-list" style="font-size:11px;color:var(--text-secondary);line-height:2"></div>
      </div>
    </div>

  </div><!-- /content-body -->
</main>

</div><!-- /app -->

<!-- Detail Modal -->
<div class="modal-overlay" id="detail-modal" onclick="closeModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-body" id="modal-body"></div>
  </div>
</div>

<!-- Back to Top -->
<button class="back-to-top" id="back-to-top" onclick="scrollToTop()">â¬†</button>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ==================== STATE ====================
let allNews = [];
let filteredNews = [];
let currentCategory = 'all';
let currentRegion = 'all';
let searchQuery = '';
let refreshTimer = null;
let lastUpdateTime = null;
let hotSectionExpanded = true;

const SETTINGS_KEY = 'news_app_settings';
const AI_CONFIG_KEY = 'news_app_ai_config';
const TRANSLATE_CACHE_KEY = 'news_app_translations';
let isTranslating = false;
let translateProgress = { done: 0, total: 0 };
let currentHotPlatform = 'all';
const HOT_SOURCES = ['æŠ–éŸ³çƒ­æœ', 'å°çº¢ä¹¦çƒ­é—¨', 'ä»Šæ—¥å¤´æ¡', '36æ°ªå¿«è®¯'];
let trendData = null;
let trendExpanded = true;

const PAGE_TITLES = {
  all: 'å…¨éƒ¨æ–°é—»',
  cn: 'å›½å†…çƒ­æœ',
  finance: 'è´¢ç»èµ„è®¯',
  world: 'å¤–åª’å¿«è®¯',
  tech: 'ç§‘æŠ€åŠ¨æ€',
  discover: 'çƒ­ç‚¹å‘ç°',
  zh: 'ä¸­æ–‡æ–°é—»',
  en: 'English News'
};

// ==================== INIT ====================
document.addEventListener('DOMContentLoaded', () => {
  loadNews();
  loadSettings();
  loadAIConfig();
  initBackToTop();
  
  const settings = getSettings();
  if(settings.refresh !== false){
    refreshTimer = setInterval(loadNews, 5 * 60 * 1000);
  }
});

// ==================== SIDEBAR ====================
function toggleSidebar(){
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebar-overlay');
  sidebar.classList.toggle('open');
  overlay.classList.toggle('show');
  document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : '';
}

function closeSidebar(){
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebar-overlay');
  sidebar.classList.remove('open');
  overlay.classList.remove('show');
  document.body.style.overflow = '';
}

function sidebarFilter(cat){
  currentCategory = cat;
  currentRegion = 'all';
  
  // Update sidebar active state
  document.querySelectorAll('.nav-group .nav-item[data-cat]').forEach(item => {
    item.classList.toggle('active', item.dataset.cat === cat);
  });
  
  // Update page title
  document.getElementById('page-title').textContent = PAGE_TITLES[cat] || 'æ–°é—»';
  
  // Switch to news view
  switchView('news');
  
  applyFilters();
  closeSidebar();
}

function sidebarHotFilter(platform){
  currentHotPlatform = platform;
  
  // Update hot tabs
  document.querySelectorAll('.hot-tab').forEach(t => t.classList.toggle('active', t.dataset.platform === platform));
  
  // Switch to news view and scroll to hot section
  switchView('news');
  renderHotTrending();
  
  closeSidebar();
  
  // Scroll to hot section
  setTimeout(() => {
    document.getElementById('hot-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 100);
}

function toggleHotNav(){
  const header = document.getElementById('hot-nav-header');
  const body = document.getElementById('hot-nav-body');
  header.classList.toggle('collapsed');
  body.classList.toggle('collapsed');
}

function toggleHotSection(){
  hotSectionExpanded = !hotSectionExpanded;
  const list = document.getElementById('hot-list');
  const tabs = document.getElementById('hot-tabs');
  const btn = document.getElementById('hot-collapse-btn');
  
  if(hotSectionExpanded){
    list.style.display = '';
    tabs.style.display = '';
    btn.textContent = 'æ”¶èµ·';
  } else {
    list.style.display = 'none';
    tabs.style.display = 'none';
    btn.textContent = 'å±•å¼€';
  }
}

// ==================== BACK TO TOP ====================
function initBackToTop(){
  const btn = document.getElementById('back-to-top');
  window.addEventListener('scroll', () => {
    btn.classList.toggle('show', window.scrollY > 400);
  }, { passive: true });
}

function scrollToTop(){
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ==================== DATA ====================
async function loadNews(){
  try {
    const resp = await fetch('data/news.json?t=' + Date.now());
    if(!resp.ok) throw new Error('æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨');
    const data = await resp.json();
    
    allNews = data.items || [];
    lastUpdateTime = data.last_update;
    
    const updateTime = lastUpdateTime ? formatTime(lastUpdateTime) : 'æœªçŸ¥';
    document.getElementById('header-meta').textContent = 
      `${allNews.length} æ¡ Â· ${data.sources || '?'} æº Â· ${updateTime}`;
    
    // Sidebar update
    document.getElementById('sidebar-update').innerHTML = 
      `<span class="update-dot"></span>${allNews.length} æ¡æ–°é—» Â· æ›´æ–°: ${updateTime}`;
    
    // Breaking banner
    const breaking = allNews.find(n => n.importance >= 5);
    if(breaking){
      document.getElementById('breaking-banner').style.display = 'block';
      document.getElementById('breaking-title').textContent = breaking.title;
      document.getElementById('breaking-banner').onclick = () => openDetail(breaking);
    }
    
    // Update sidebar counts
    updateCategoryCounts();
    
    // Settings data info
    document.getElementById('data-info').innerHTML = 
      `å…± ${allNews.length} æ¡æ–°é—»<br>æ¥è‡ª ${data.sources} ä¸ªæ•°æ®æº<br>æœ€åæ›´æ–°: ${updateTime}<br>æ•°æ®æ–‡ä»¶: data/news.json`;
    
    // Source list
    const sources = [...new Set(allNews.map(n => `${n.source_icon} ${n.source}`))];
    document.getElementById('source-list').innerHTML = sources.join('<br>');
    
    applyFilters();
    renderHotTrending();
    updateHotCounts();
    loadTrends();
    
    document.getElementById('loading').style.display = 'none';
    
    autoTranslateNews();
    
  } catch(e){
    console.error('Load failed:', e);
    document.getElementById('loading').style.display = 'none';
    document.getElementById('empty-state').style.display = 'block';
  }
}

async function refreshNews(){
  showToast('ğŸ”„ åˆ·æ–°ä¸­...');
  await loadNews();
  showToast('âœ… å·²åˆ·æ–°');
}

// ==================== TRANSLATION ====================
function getTranslateCache(){
  try { return JSON.parse(localStorage.getItem(TRANSLATE_CACHE_KEY)) || {}; }
  catch(e) { return {}; }
}
function saveTranslateCache(cache){
  try { localStorage.setItem(TRANSLATE_CACHE_KEY, JSON.stringify(cache)); } catch(e) {}
}

async function autoTranslateNews(){
  const cfg = getAIConfig();
  if(!cfg.apiKey || !cfg.apiUrl) return;
  
  const cache = getTranslateCache();
  const enItems = allNews.filter(n => n.lang === 'en' && !cache[n.id]);
  if(enItems.length === 0){
    applyCachedTranslations();
    return;
  }
  
  applyCachedTranslations();
  
  isTranslating = true;
  translateProgress = { done: 0, total: enItems.length };
  showTranslateStatus();
  
  const batchSize = 20;
  for(let i = 0; i < enItems.length; i += batchSize){
    const batch = enItems.slice(i, i + batchSize);
    try {
      await translateBatch(batch, cfg, cache);
    } catch(e){
      console.error('Translation batch failed:', e);
    }
    translateProgress.done = Math.min(i + batchSize, enItems.length);
    showTranslateStatus();
  }
  
  saveTranslateCache(cache);
  applyCachedTranslations();
  applyFilters();
  
  isTranslating = false;
  showToast(`âœ… å·²ç¿»è¯‘ ${translateProgress.total} æ¡æ–°é—»`);
  hideTranslateStatus();
}

async function translateBatch(items, cfg, cache){
  const lines = items.map((n, j) => `${j+1}. [æ ‡é¢˜] ${n.title}\n   [æ‘˜è¦] ${(n.summary||'').substring(0,200)}`);
  const prompt = lines.join('\n');
  
  const systemPrompt = `ä½ æ˜¯ä¸“ä¸šæ–°é—»ç¿»è¯‘å™¨ã€‚å°†ä»¥ä¸‹ç¼–å·çš„è‹±æ–‡æ–°é—»æ ‡é¢˜å’Œæ‘˜è¦ç¿»è¯‘æˆç®€æ´æµç•…çš„ä¸­æ–‡ã€‚
è§„åˆ™ï¼š
1. ä¸¥æ ¼ä¿æŒç¼–å·æ ¼å¼
2. æ¯æ¡è¾“å‡ºæ ¼å¼: ç¼–å·. [æ ‡é¢˜] ä¸­æ–‡æ ‡é¢˜ [æ‘˜è¦] ä¸­æ–‡æ‘˜è¦
3. äººååœ°åç”¨é€šç”¨ä¸­æ–‡è¯‘å
4. ä¿æŒæ–°é—»æ ‡é¢˜ç®€æ´é£æ ¼
5. åªè¾“å‡ºç¿»è¯‘ï¼Œä¸åŠ ä»»ä½•è§£é‡Š`;
  
  const resp = await fetch(cfg.apiUrl + '/chat/completions', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + cfg.apiKey },
    body: JSON.stringify({
      model: cfg.model || 'deepseek-ai/DeepSeek-V3',
      messages: [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: prompt }
      ],
      max_tokens: 3000,
      temperature: 0.3
    })
  });
  
  const data = await resp.json();
  const reply = data.choices?.[0]?.message?.content || '';
  
  const replyLines = reply.split('\n').filter(l => l.trim());
  let currentNum = -1;
  let currentTitle = '';
  let currentSummary = '';
  
  for(const line of replyLines){
    const m = line.match(/^(\d+)\s*[.ã€ï¼]\s*(.*)/);
    if(m){
      if(currentNum >= 0 && currentNum < items.length){
        cache[items[currentNum].id] = { title: currentTitle.trim(), summary: currentSummary.trim() };
      }
      currentNum = parseInt(m[1]) - 1;
      const rest = m[2];
      const titleMatch = rest.match(/\[æ ‡é¢˜[\]ã€‘]\s*(.*)/);
      const summaryMatch = rest.match(/\[æ‘˜è¦[\]ã€‘]\s*(.*)/);
      if(titleMatch && summaryMatch){
        currentTitle = titleMatch[1].replace(/\s*\[æ‘˜è¦.*/, '');
        currentSummary = summaryMatch[1];
      } else if(titleMatch){
        currentTitle = titleMatch[1];
        currentSummary = '';
      } else {
        currentTitle = rest;
        currentSummary = '';
      }
    } else if(currentNum >= 0){
      const sm = line.match(/\s*\[æ‘˜è¦[\]ã€‘]\s*(.*)/);
      if(sm){ currentSummary = sm[1]; }
      else { currentSummary += ' ' + line.trim(); }
    }
  }
  if(currentNum >= 0 && currentNum < items.length){
    cache[items[currentNum].id] = { title: currentTitle.trim(), summary: currentSummary.trim() };
  }
}

function applyCachedTranslations(){
  const cache = getTranslateCache();
  allNews.forEach(n => {
    if(n.lang === 'en' && cache[n.id]){
      const t = cache[n.id];
      if(t.title){
        n.title_original = n.title_original || n.title;
        n.title = t.title;
      }
      if(t.summary){
        n.summary_original = n.summary_original || n.summary;
        n.summary = t.summary;
      }
      n.lang = 'zh-translated';
    }
  });
}

function showTranslateStatus(){
  let bar = document.getElementById('translate-bar');
  if(!bar){
    bar = document.createElement('div');
    bar.id = 'translate-bar';
    bar.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:999;background:var(--accent);color:white;text-align:center;padding:4px 0;font-size:12px;font-weight:600;transition:opacity 0.3s';
    document.body.appendChild(bar);
  }
  bar.textContent = `ğŸŒ ç¿»è¯‘ä¸­... ${translateProgress.done}/${translateProgress.total}`;
  bar.style.opacity = '1';
}

function hideTranslateStatus(){
  const bar = document.getElementById('translate-bar');
  if(bar){ bar.style.opacity = '0'; setTimeout(() => bar?.remove(), 300); }
}

async function manualTranslate(){
  const cfg = getAIConfig();
  if(!cfg.apiKey || !cfg.apiUrl){
    showToast('âŒ è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®AI API');
    switchView('settings');
    return;
  }
  if(isTranslating){
    showToast('â³ ç¿»è¯‘æ­£åœ¨è¿›è¡Œä¸­...');
    return;
  }
  await autoTranslateNews();
}

// ==================== SOURCE GROUP DEFINITIONS ====================
const SOURCE_GROUPS = {
  cn: ['æŠ–éŸ³çƒ­æœ', 'å°çº¢ä¹¦çƒ­é—¨', 'ä»Šæ—¥å¤´æ¡', 'æ–°æµªè´¢ç»'],
  finance: ['æ–°æµªè´¢ç»', 'Bloomberg', 'CNBC Top', 'WSJ Markets', 'FT World', '36æ°ªå¿«è®¯'],
  world: ['BBC World', 'BBC Politics', 'BBCä¸­æ–‡', 'Al Jazeera', 'The Guardian World', 'NPR World', 'DWå¾·å›½ä¹‹å£°', 'éŸ©è”ç¤¾ä¸­æ–‡', 'çº½çº¦æ—¶æŠ¥ä¸­æ–‡'],
  tech: ['TechCrunch', '36æ°ªå¿«è®¯'],
  discover: ['ğŸ”¬ çƒ­ç‚¹å‘ç°'],
};

// ==================== FILTERS ====================
function filterCategory(cat){
  currentCategory = cat;
  currentRegion = 'all';
  document.querySelectorAll('.nav-group .nav-item[data-cat]').forEach(item => {
    item.classList.toggle('active', item.dataset.cat === cat);
  });
  document.getElementById('page-title').textContent = PAGE_TITLES[cat] || 'æ–°é—»';
  applyFilters();
}

function handleSearch(q){
  searchQuery = q.toLowerCase().trim();
  applyFilters();
}

function applyFilters(){
  const settings = getSettings();
  
  filteredNews = allNews.filter(n => {
    if(currentCategory !== 'all') {
      if(currentCategory === 'zh') {
        if(n.lang !== 'zh' && n.lang !== 'zh-translated') return false;
      } else if(currentCategory === 'en') {
        if(n.lang !== 'en') return false;
      } else {
        const groupSources = SOURCE_GROUPS[currentCategory];
        if(groupSources && !groupSources.includes(n.source)) return false;
      }
    }
    if(currentRegion !== 'all' && !(n.regions||[]).includes(currentRegion)) return false;
    if(searchQuery && !n.title.toLowerCase().includes(searchQuery) && 
       !(n.summary||'').toLowerCase().includes(searchQuery)) return false;
    if(settings.zhonly && n.lang !== 'zh' && n.lang !== 'zh-translated') return false;
    return true;
  });
  
  renderNewsList();
}

function updateCategoryCounts(){
  const counts = { all: allNews.length, zh: 0, en: 0 };
  Object.keys(SOURCE_GROUPS).forEach(g => counts[g] = 0);
  allNews.forEach(n => {
    if(n.lang === 'zh' || n.lang === 'zh-translated') counts.zh++;
    if(n.lang === 'en') counts.en++;
    Object.entries(SOURCE_GROUPS).forEach(([group, sources]) => {
      if(sources.includes(n.source)) counts[group]++;
    });
  });
  
  // Update sidebar counts
  Object.entries(counts).forEach(([key, count]) => {
    const el = document.getElementById('count-' + key);
    if(el) el.textContent = count;
  });
}

function updateHotCounts(){
  const hotItems = allNews.filter(n => HOT_SOURCES.includes(n.source));
  const counts = {};
  hotItems.forEach(n => {
    counts[n.source] = (counts[n.source] || 0) + 1;
  });
  
  const map = {
    'æŠ–éŸ³çƒ­æœ': 'hot-count-douyin',
    'å°çº¢ä¹¦çƒ­é—¨': 'hot-count-xhs',
    'ä»Šæ—¥å¤´æ¡': 'hot-count-tt',
    '36æ°ªå¿«è®¯': 'hot-count-kr'
  };
  
  Object.entries(map).forEach(([source, elId]) => {
    const el = document.getElementById(elId);
    if(el) el.textContent = counts[source] || '';
  });
}

// ==================== HOT TRENDING ====================
function filterHotPlatform(platform){
  currentHotPlatform = platform;
  document.querySelectorAll('.hot-tab').forEach(t => t.classList.toggle('active', t.dataset.platform === platform));
  renderHotTrending();
}

function renderHotTrending(){
  const container = document.getElementById('hot-list');
  if(!container) return;
  
  let hotItems = allNews.filter(n => HOT_SOURCES.includes(n.source));
  if(currentHotPlatform !== 'all'){
    hotItems = hotItems.filter(n => n.source === currentHotPlatform);
  }
  
  hotItems.sort((a, b) => {
    const ha = a.hot_value || 0, hb = b.hot_value || 0;
    if(hb !== ha) return hb - ha;
    return b.importance - a.importance;
  });
  
  hotItems = hotItems.slice(0, 20);
  
  if(hotItems.length === 0){
    container.innerHTML = '<div style="padding:24px;text-align:center;color:var(--text-secondary);font-size:12px">æš‚æ— çƒ­æœæ•°æ®</div>';
    return;
  }
  
  container.innerHTML = hotItems.map((n, i) => {
    const rankClass = i === 0 ? 'top1' : i === 1 ? 'top2' : i === 2 ? 'top3' : 'normal';
    const hotVal = n.hot_value ? formatHotValue(n.hot_value) : '';
    return `
      <div class="hot-item" onclick="openDetail(allNews.find(x=>x.id==='${n.id}'))">
        <div class="hot-rank ${rankClass}">${i + 1}</div>
        <div class="hot-info">
          <div class="hot-title-text">${escapeHtml(n.title)}</div>
          <div class="hot-meta">
            <span class="hot-platform-badge ${n.source === '36æ°ªå¿«è®¯' ? 'kr36' : n.source}">${n.source_icon} ${n.source}</span>
            <span class="hot-cat-tag cat-${n.category}">${n.category}</span>
            ${hotVal ? `<span class="hot-heat">ğŸ”¥ ${hotVal}</span>` : ''}
          </div>
        </div>
      </div>`;
  }).join('');
}

function formatHotValue(v){
  if(!v || v <= 0) return '';
  if(v >= 10000000) return (v / 10000000).toFixed(1) + 'åƒä¸‡';
  if(v >= 10000) return (v / 10000).toFixed(1) + 'ä¸‡';
  return v.toLocaleString();
}

// ==================== TREND DISCOVERY ====================
async function loadTrends(){
  try {
    const resp = await fetch('data/trends.json?t=' + Date.now());
    if(!resp.ok) return;
    trendData = await resp.json();
    renderTrendDiscovery();
  } catch(e){
    console.debug('No trend data:', e.message);
  }
}

function renderTrendDiscovery(){
  if(!trendData || !trendData.trends || trendData.trends.length === 0) {
    document.getElementById('trend-section').style.display = 'none';
    return;
  }
  
  const section = document.getElementById('trend-section');
  section.style.display = 'block';
  
  const trends = trendData.trends;
  const burstCount = trends.filter(t => t.is_burst).length;
  const risingCount = trends.filter(t => t.trend_direction === 'â†‘' || t.trend_direction === 'â†—').length;
  
  const summary = document.getElementById('trend-summary');
  summary.innerHTML = `
    <div class="trend-summary-chip total-count">ğŸ”¬ ${trends.length} ä¸ªè¶‹åŠ¿</div>
    ${burstCount > 0 ? `<div class="trend-summary-chip burst-count">ğŸ”´ ${burstCount} çªå‘</div>` : ''}
    ${risingCount > 0 ? `<div class="trend-summary-chip rising-count">ğŸ“ˆ ${risingCount} ä¸Šå‡</div>` : ''}
  `;
  
  const grid = document.getElementById('trend-grid');
  const displayTrends = trendExpanded ? trends.slice(0, 12) : trends.slice(0, 3);
  
  grid.innerHTML = displayTrends.map((t, i) => {
    const heatPct = Math.min(100, t.heat_score);
    const heatClass = heatPct >= 60 ? 'high' : heatPct >= 30 ? 'medium' : 'low';
    const cardClass = t.is_burst ? 'burst' : t.macd_signal === 'bullish' ? 'bullish' : '';
    const sparkClass = t.is_burst ? 'burst' : t.macd_signal === 'bullish' ? 'bullish' : 'neutral';
    
    return `
      <div class="trend-card ${cardClass}">
        <div class="trend-card-top">
          <span class="trend-rank-num">#${i + 1}</span>
          <div class="trend-platforms">
            ${(t.platforms || []).map(p => `<div class="trend-platform-dot ${p}" title="${p}"></div>`).join('')}
          </div>
          <span class="trend-direction">${t.trend_direction}</span>
        </div>
        <div class="trend-heat-bar"><div class="trend-heat-fill ${heatClass}" style="width:${heatPct}%"></div></div>
        <div class="trend-keyword">
          ${escapeHtml(t.keyword)}
          ${t.is_burst ? '<span class="burst-badge">BURST</span>' : ''}
          ${t.macd_signal === 'bullish' ? '<span class="macd-badge bullish">â†‘</span>' : ''}
          ${t.macd_signal === 'bearish' ? '<span class="macd-badge bearish">â†“</span>' : ''}
        </div>
        <div class="trend-meta">
          <span class="trend-meta-item heat">ğŸ”¥ ${t.heat_score.toFixed(1)}</span>
          <span class="trend-meta-item">é¢‘ç‡:${t.frequency}</span>
          <span class="trend-meta-item">${t.category || ''}</span>
        </div>
        ${renderSparkline(t.sparkline || [], sparkClass)}
        ${t.related_titles && t.related_titles[0] ? `<div class="trend-related">ğŸ“ ${escapeHtml(t.related_titles[0].substring(0,40))}</div>` : ''}
      </div>`;
  }).join('');
}

function renderSparkline(data, styleClass){
  if(!data || data.length < 2) return '';
  
  const width = 140, height = 28;
  const max = Math.max(...data, 1);
  const step = width / (data.length - 1);
  
  const points = data.map((v, i) => `${(i * step).toFixed(1)},${(height - (v / max) * (height - 4) - 2).toFixed(1)}`);
  const linePath = 'M' + points.join(' L');
  const areaPath = linePath + ` L${width},${height} L0,${height} Z`;
  
  return `
    <div class="trend-sparkline ${styleClass}">
      <svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">
        <path class="spark-area" d="${areaPath}"/>
        <path class="spark-line" d="${linePath}"/>
      </svg>
    </div>`;
}

function toggleTrendExpand(){
  trendExpanded = !trendExpanded;
  renderTrendDiscovery();
}

// ==================== RENDER ====================
function renderNewsList(){
  const container = document.getElementById('news-list');
  
  if(filteredNews.length === 0){
    container.innerHTML = `
      <div class="empty">
        <div class="empty-icon">ğŸ”</div>
        <div class="empty-title">æœªæ‰¾åˆ°åŒ¹é…æ–°é—»</div>
        <div class="empty-desc">å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶æˆ–æœç´¢å…³é”®è¯</div>
      </div>`;
    return;
  }
  
  container.innerHTML = filteredNews.map(n => {
    const hasImg = n.image && !n.image.includes('undefined');
    const importanceStars = n.importance >= 5 ? 'ğŸ”´' : n.importance >= 4 ? 'ğŸŸ ' : '';
    
    return `
      <div class="news-card importance-${n.importance} ${hasImg ? 'has-image' : ''}" onclick="openDetail(allNews.find(x=>x.id==='${n.id}'))">
        <div class="news-inner">
          <div>
            <div class="news-top">
              <span class="news-source">${n.source_icon} ${n.source}</span>
              <span class="news-time">${formatTimeShort(n.pub_date)}</span>
              <span class="news-cat cat-${n.category}">${n.category}</span>
              ${importanceStars ? `<span class="news-importance">${importanceStars}</span>` : ''}
            </div>
            <div class="news-title">${escapeHtml(n.title)}</div>
            ${n.summary ? `<div class="news-summary">${escapeHtml(n.summary)}</div>` : ''}
          </div>
          ${hasImg ? `<img class="news-image" src="${n.image}" alt="" onerror="this.style.display='none';this.closest('.news-card').classList.remove('has-image')" loading="lazy">` : ''}
        </div>
        <div class="news-bottom">
          ${(n.regions||[]).map(r => `<span class="news-region">${r}</span>`).join('')}
          <span class="news-lang">${n.lang === 'zh' ? 'ä¸­æ–‡' : n.lang === 'zh-translated' ? 'å·²ç¿»è¯‘' : 'EN'}</span>
        </div>
      </div>`;
  }).join('');
}

function renderTimeline(){
  const container = document.getElementById('view-timeline');
  
  const grouped = {};
  allNews.forEach(n => {
    const date = (n.pub_date || '').split('T')[0] || 'æœªçŸ¥';
    if(!grouped[date]) grouped[date] = [];
    grouped[date].push(n);
  });
  
  const dates = Object.keys(grouped).sort().reverse();
  
  container.innerHTML = dates.map(date => {
    const items = grouped[date];
    const dateLabel = formatDateLabel(date);
    
    return `
      <div class="timeline-date">${dateLabel} <span style="font-size:10px;color:var(--text-secondary);font-weight:400">(${items.length}æ¡)</span></div>
      ${items.map(n => `
        <div class="timeline-item" onclick="openDetail(allNews.find(x=>x.id==='${n.id}'))">
          <div class="timeline-dot ${n.importance >= 5 ? 'high' : n.importance >= 4 ? 'medium' : ''}"></div>
          <div class="timeline-content">
            <div class="timeline-time">${formatTimeOnly(n.pub_date)} Â· ${n.source_icon} ${n.source}</div>
            <div class="timeline-title">${escapeHtml(n.title)}</div>
            <div class="timeline-source"><span class="news-cat cat-${n.category}" style="font-size:9px">${n.category}</span></div>
          </div>
        </div>
      `).join('')}
    `;
  }).join('');
}

// ==================== DETAIL MODAL ====================
function openDetail(news){
  if(!news) return;
  
  const modal = document.getElementById('detail-modal');
  const body = document.getElementById('modal-body');
  
  body.innerHTML = `
    <div class="modal-cat cat-${news.category}">${news.category}</div>
    <div class="modal-title">${escapeHtml(news.title)}</div>
    <div class="modal-meta">
      <div class="modal-meta-item">${news.source_icon} ${news.source}</div>
      <div class="modal-meta-item">ğŸ• ${formatTime(news.pub_date)}</div>
      <div class="modal-meta-item">${'â­'.repeat(Math.min(news.importance, 5))} é‡è¦æ€§</div>
    </div>
    ${news.image ? `<img src="${news.image}" style="width:100%;border-radius:12px;margin-bottom:14px" onerror="this.style.display='none'" alt="">` : ''}
    ${news.summary ? `<div class="modal-summary">${escapeHtml(news.summary)}</div>` : ''}
    <div class="modal-regions">
      ${(news.regions||[]).map(r => `<span class="news-region" style="font-size:11px;padding:4px 10px">${r}</span>`).join('')}
      <span class="news-lang" style="font-size:11px;padding:4px 10px">${news.lang === 'zh' ? 'ğŸ‡¨ğŸ‡³ ä¸­æ–‡' : news.lang === 'zh-translated' ? 'ğŸŒ AIç¿»è¯‘' : 'ğŸ‡¬ğŸ‡§ English'}</span>
      ${news.title_original ? `<div style="margin-top:10px;padding:10px 14px;background:rgba(255,255,255,0.04);border-radius:8px;font-size:11px;color:var(--text-secondary)">åŸæ ‡é¢˜: ${escapeHtml(news.title_original)}</div>` : ''}
    </div>
    <div id="ai-analysis-container"></div>
    ${news.link ? `<a class="modal-link" href="${news.link}" target="_blank" rel="noopener">ğŸ“– é˜…è¯»åŸæ–‡ â†’</a>` : ''}
  `;
  
  modal.classList.add('show');
  
  const aiCfg = getAIConfig();
  if(aiCfg.apiKey && aiCfg.apiUrl){
    analyzeNewsWithAI(news);
  }
}

function closeModal(e){
  if(e.target.classList.contains('modal-overlay')){
    e.target.classList.remove('show');
  }
}

// ==================== AI ANALYSIS ====================
async function analyzeNewsWithAI(news){
  const container = document.getElementById('ai-analysis-container');
  container.innerHTML = '<div class="ai-loading"><div class="spinner" style="width:24px;height:24px;border-width:2px"></div><div style="margin-top:8px">ğŸ¤– AIæ­£åœ¨åˆ†æ...</div></div>';
  
  const cfg = getAIConfig();
  const prompt = `è¯·ç”¨ä¸­æ–‡å¯¹ä»¥ä¸‹æ–°é—»è¿›è¡Œç®€è¦æ·±åº¦åˆ†æ(200å­—ä»¥å†…)ï¼ŒåŒ…æ‹¬ï¼š
1. ğŸ“Œ æ ¸å¿ƒè¦ç‚¹ï¼ˆä¸€å¥è¯ï¼‰
2. ğŸŒ å½±å“èŒƒå›´å’Œç¨‹åº¦
3. ğŸ’¡ å¯¹ä¸­å›½/æŠ•èµ„è€…çš„å¯ç¤º
4. ğŸ”® åç»­å¯èƒ½å‘å±•

æ–°é—»æ ‡é¢˜: ${news.title}
æ¥æº: ${news.source}
åˆ†ç±»: ${news.category}
å†…å®¹: ${news.summary || 'æ— è¯¦ç»†å†…å®¹'}`;

  try {
    const resp = await fetch(cfg.apiUrl + '/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + cfg.apiKey },
      body: JSON.stringify({
        model: cfg.model || 'deepseek-ai/DeepSeek-V3',
        messages: [
          { role: 'system', content: 'ä½ æ˜¯ä¸€ä½èµ„æ·±çš„æ—¶äº‹æ”¿ç»åˆ†æä¸“å®¶ï¼Œå–„äºä»å…¨çƒè§†è§’è§£è¯»æ–°é—»äº‹ä»¶çš„æ·±å±‚å½±å“ã€‚å›ç­”è¦ç®€æ´æœ‰æ´å¯ŸåŠ›ã€‚' },
          { role: 'user', content: prompt }
        ],
        max_tokens: 500,
        temperature: 0.7
      })
    });
    
    const data = await resp.json();
    const analysis = data.choices?.[0]?.message?.content || 'åˆ†æå¤±è´¥';
    
    container.innerHTML = `
      <div class="ai-section">
        <div class="ai-section-title">ğŸ¤– AI æ·±åº¦åˆ†æ</div>
        <div class="ai-section-text">${formatAIText(analysis)}</div>
      </div>`;
  } catch(e){
    container.innerHTML = `<div class="ai-section" style="border-color:rgba(255,107,107,0.3);background:rgba(255,107,107,0.06)">
      <div class="ai-section-title" style="color:var(--red)">âŒ AIåˆ†æå¤±è´¥</div>
      <div class="ai-section-text" style="font-size:11px">${e.message}<br>è¯·æ£€æŸ¥è®¾ç½®ä¸­çš„APIé…ç½®</div>
    </div>`;
  }
}

function formatAIText(text){
  return text
    .replace(/\n/g, '<br>')
    .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
    .replace(/#{1,3}\s*(.*?)(?:<br>|$)/g, '<b style="color:var(--accent-light)">$1</b><br>');
}

// ==================== VIEWS ====================
function switchView(view){
  // Update sidebar bottom nav
  document.querySelectorAll('.sidebar-bottom .nav-item').forEach(item => {
    item.classList.toggle('active', item.dataset.view === view);
  });
  
  document.getElementById('view-news').style.display = view === 'news' ? 'block' : 'none';
  document.getElementById('view-timeline').style.display = view === 'timeline' ? 'block' : 'none';
  document.getElementById('view-settings').style.display = view === 'settings' ? 'block' : 'none';
  
  // Show/hide sections based on view
  document.getElementById('hot-section').style.display = view === 'news' ? 'block' : 'none';
  document.getElementById('trend-section').style.display = 
    (view === 'news' && trendData && trendData.trends && trendData.trends.length > 0) ? 'block' : 'none';
  document.getElementById('breaking-banner').style.display = 
    (view === 'news' && allNews.some(n => n.importance >= 5)) ? 'block' : 'none';
  
  // Update page title
  if(view === 'timeline'){
    document.getElementById('page-title').textContent = 'æ—¶é—´çº¿';
    renderTimeline();
  } else if(view === 'settings'){
    document.getElementById('page-title').textContent = 'è®¾ç½®';
  } else {
    document.getElementById('page-title').textContent = PAGE_TITLES[currentCategory] || 'å…¨éƒ¨æ–°é—»';
  }
  
  closeSidebar();
}

// ==================== SETTINGS ====================
function getSettings(){
  try { return JSON.parse(localStorage.getItem(SETTINGS_KEY)) || { refresh: true }; } 
  catch(e) { return { refresh: true }; }
}
function saveSettings(s){
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
}

function toggleSetting(key){
  const settings = getSettings();
  settings[key] = !settings[key];
  saveSettings(settings);
  
  const toggle = document.getElementById('toggle-' + key);
  toggle.classList.toggle('on', settings[key]);
  
  if(key === 'refresh'){
    if(settings.refresh){
      refreshTimer = setInterval(loadNews, 5 * 60 * 1000);
      showToast('âœ… è‡ªåŠ¨åˆ·æ–°å·²å¼€å¯');
    } else {
      clearInterval(refreshTimer);
      showToast('â¸ï¸ è‡ªåŠ¨åˆ·æ–°å·²å…³é—­');
    }
  }
  
  if(key === 'notify' && settings.notify){
    requestNotificationPermission();
  }
  
  if(key === 'zhonly'){
    applyFilters();
    showToast(settings.zhonly ? 'ğŸ‡¨ğŸ‡³ ä»…æ˜¾ç¤ºä¸­æ–‡' : 'ğŸŒ æ˜¾ç¤ºå…¨éƒ¨è¯­è¨€');
  }
}

function loadSettings(){
  const settings = getSettings();
  document.getElementById('toggle-refresh').classList.toggle('on', settings.refresh !== false);
  document.getElementById('toggle-notify').classList.toggle('on', !!settings.notify);
  document.getElementById('toggle-zhonly').classList.toggle('on', !!settings.zhonly);
}

function getAIConfig(){
  try { return JSON.parse(localStorage.getItem(AI_CONFIG_KEY)) || {}; } 
  catch(e) { return {}; }
}
function saveAIConfig(){
  const cfg = {
    apiUrl: document.getElementById('ai-api-url').value.trim(),
    apiKey: document.getElementById('ai-api-key').value.trim(),
    model: document.getElementById('ai-api-model').value.trim()
  };
  localStorage.setItem(AI_CONFIG_KEY, JSON.stringify(cfg));
  showToast('âœ… AIé…ç½®å·²ä¿å­˜');
}
function loadAIConfig(){
  const cfg = getAIConfig();
  if(cfg.apiUrl) document.getElementById('ai-api-url').value = cfg.apiUrl;
  if(cfg.apiKey) document.getElementById('ai-api-key').value = cfg.apiKey;
  if(cfg.model) document.getElementById('ai-api-model').value = cfg.model;
}

// ==================== NOTIFICATIONS ====================
async function requestNotificationPermission(){
  if(!('Notification' in window)){
    showToast('âŒ æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥');
    return;
  }
  const perm = await Notification.requestPermission();
  if(perm === 'granted'){
    showToast('âœ… é€šçŸ¥å·²å¼€å¯');
    new Notification('ğŸŒ å…¨çƒçƒ­ç‚¹', { body: 'çªå‘æ–°é—»å°†é€šè¿‡é€šçŸ¥æ¨é€ç»™ä½ ', icon: 'ğŸŒ' });
  } else {
    showToast('âŒ é€šçŸ¥æƒé™è¢«æ‹’ç»');
    const settings = getSettings();
    settings.notify = false;
    saveSettings(settings);
    document.getElementById('toggle-notify').classList.remove('on');
  }
}

// ==================== UTILS ====================
function formatTime(isoStr){
  if(!isoStr) return 'æœªçŸ¥';
  try {
    const d = new Date(isoStr);
    const now = new Date();
    const diffMs = now - d;
    const diffMin = Math.floor(diffMs / 60000);
    const diffHr = Math.floor(diffMs / 3600000);
    
    if(diffMin < 1) return 'åˆšåˆš';
    if(diffMin < 60) return `${diffMin}åˆ†é’Ÿå‰`;
    if(diffHr < 24) return `${diffHr}å°æ—¶å‰`;
    
    const month = d.getMonth() + 1;
    const day = d.getDate();
    const hour = d.getHours().toString().padStart(2, '0');
    const min = d.getMinutes().toString().padStart(2, '0');
    return `${month}æœˆ${day}æ—¥ ${hour}:${min}`;
  } catch(e) { return isoStr; }
}

function formatTimeShort(isoStr){
  if(!isoStr) return '';
  try {
    const d = new Date(isoStr);
    const now = new Date();
    const diffMs = now - d;
    const diffMin = Math.floor(diffMs / 60000);
    const diffHr = Math.floor(diffMs / 3600000);
    
    if(diffMin < 1) return 'åˆšåˆš';
    if(diffMin < 60) return `${diffMin}åˆ†å‰`;
    if(diffHr < 24) return `${diffHr}æ—¶å‰`;
    if(diffHr < 48) return 'æ˜¨å¤©';
    return `${Math.floor(diffHr/24)}å¤©å‰`;
  } catch(e) { return ''; }
}

function formatTimeOnly(isoStr){
  if(!isoStr) return '';
  try {
    const d = new Date(isoStr);
    return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
  } catch(e) { return ''; }
}

function formatDateLabel(dateStr){
  if(!dateStr) return 'æœªçŸ¥';
  const today = new Date().toISOString().split('T')[0];
  const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
  if(dateStr === today) return 'ğŸ“… ä»Šå¤©';
  if(dateStr === yesterday) return 'ğŸ“… æ˜¨å¤©';
  const d = new Date(dateStr);
  return `ğŸ“… ${d.getMonth()+1}æœˆ${d.getDate()}æ—¥ å‘¨${'æ—¥ä¸€äºŒä¸‰å››äº”å…­'[d.getDay()]}`;
}

function escapeHtml(str){
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function showToast(msg){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}
</script>
</body>
</html>
